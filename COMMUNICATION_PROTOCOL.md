# MINTASCA CAN 모터 제어 - 통신 프로토콜

## 1. 개요

이 문서는 NUCLEO-G474RE 보드를 중심으로 하는 모터 제어 및 데이터 수집 시스템의 통신 프로토콜을 정의합니다.

- **PC -> NUCLEO (UART) -> 모터/제어 보드 (CAN):** PC의 터미널 프로그램을 통해 모터를 제어하거나, 제어 보드에 데이터 요청 명령을 전송합니다.
- **제어 보드 (CAN) -> NUCLEO -> PC (UART):** 제어 보드로부터 데이터 요청에 대한 응답을 수신하여 PC로 전달합니다.

## 2. CAN 버스 프로토콜

- **통신 속도:** 1 Mbps

### 2.1. CAN ID 할당

| CAN ID | 방향 | 설명 |
| :--- | :--- | :--- |
| `0xD4` | NUCLEO <-> 모터 | 모터 제어 및 상태 응답 (모터 제조사 고정 ID) |
| `0x100` | 제어 보드 -> NUCLEO | **(응답)** 제어 보드의 데이터 전송용 고정 ID |
| `0x101` | NUCLEO -> 제어 보드 | **(요청)** 제어 보드로 명령을 보내기 위한 고정 ID |

### 2.2. 데이터 프레임: 제어 보드 -> NUCLEO (ID: 0x100) - 응답

데이터 요청(`0x101`)에 대한 응답으로, 제어 보드는 아래 형식에 맞춰 8바이트 CAN 데이터 프레임을 전송합니다.

| 바이트 인덱스 | 데이터 | 타입 | 설명 |
| :--- | :--- | :--- | :--- |
| `0` - `1` | DC-Link 전압 | `uint16_t` | Big-Endian. 단위: mV |
| `2` - `3` | 제동 저항 전류 | `uint16_t` | Big-Endian. 단위: mA |
| `4` - `5` | PWM 듀티 | `uint16_t` | Big-Endian. 0-1000 (퍼밀 ‰) |
| `6` | 핀 상태 (Flags) | `uint8_t` | 비트 필드 (아래 참조) |
| `7` | 미사용 | `uint8_t` | 예약됨 |

#### 바이트 6: 핀 상태 (Flags) 상세

| 비트 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **설명** | - | - | - | - | - | - | PWM 핀 | 히스테리시스 핀 |
| **값** | 예약 | 예약 | 예약 | 예약 | 예약 | 예약 | `0` 또는 `1` | `0` 또는 `1` |

### 2.3. 데이터 프레임: NUCLEO -> 제어 보드 (ID: 0x101) - 요청

NUCLEO 보드는 제어 보드에 데이터를 요청하기 위해 아래 형식의 CAN 메시지를 전송합니다.

| 바이트 인덱스 | 데이터 | 값 | 설명 |
| :--- | :--- | :--- | :--- |
| `0` | Command | `0x01` | `0x01`: 현재 센서 데이터 요청 |
| `1` - `7` | 미사용 | - | 예약됨 |

## 3. UART 프로토콜 (NUCLEO <-> PC)

- **통신 속도:** 115200 bps
- **설정:** 8-N-1

### 3.1. PC -> NUCLEO (CAN 메시지 전송)

PC는 아래와 같은 형식의 문자열을 전송하여 CAN 메시지를 보낼 수 있습니다. 모든 값은 공백으로 구분합니다.

- **형식:** `ID DLC D0 D1 D2 D3 D4 D5 D6 D7`
  - `ID`: 16진수 CAN ID
  - `DLC`: 10진수 Data Length Code (0-8)
  - `D0`~`D7`: 16진수 데이터 바이트

- **모터 제어 예시:** `D4 8 11 22 33 44 55 66 77 88`
- **제어 보드 데이터 요청 예시:** `101 1 1`

### 3.2. NUCLEO -> PC (CAN 메시지 수신)

NUCLEO 보드는 수신한 모든 CAN 메시지를 PC에서 디버깅 및 파싱하기 용이한 단일 형식으로 전달합니다.

- **형식:** `ID: 0x..., DLC: ..., Data: ...\r\n`
  - `ID`: 16진수 CAN ID
  - `DLC`: 10진수 Data Length Code
  - `Data`: 공백으로 구분된 16진수 데이터 바이트들

- **제어 보드 데이터 수신 예시 (ID: 0x100):** `ID: 0x100, DLC: 8, Data: 5E 5A 04 D2 01 F4 01 00`
- **모터 상태 응답 예시 (ID: 0x0D4):** `ID: 0x0D4, DLC: 8, Data: 01 02 03 04 05 06 07 08`

## 4. 통신 시나리오 (데이터 요청 및 수신)

1.  **PC (Python):** 제어 보드의 데이터가 필요할 때, NUCLEO 보드의 시리얼 포트로 다음 문자열을 전송합니다.
    `101 1 1\r\n`
2.  **NUCLEO 보드:** UART 문자열을 파싱하여 ID `0x101`, DLC `1`, Data `0x01`을 담은 CAN 메시지를 제어 보드로 전송합니다.
3.  **제어 보드:** ID `0x101`과 명령 코드 `0x01`을 수신하고, 현재 센서 데이터를 ID `0x100`의 CAN 메시지에 담아 응답합니다.
4.  **NUCLEO 보드:** ID `0x100` 메시지를 수신하고, `HAL_FDCAN_RxFifo0Callback` 함수에서 이를 일반 모니터링 형식으로 변환하여 PC로 전송합니다.
    - 예시: `ID: 0x100, DLC: 8, Data: 5E 5A 04 D2 01 F4 01 00`
5.  **PC (Python):** 수신한 문자열을 파싱합니다. ID가 `0x100`인 경우, 데이터 바이트(`5E 5A`, `04 D2` 등)를 실제 물리 값(전압, 전류 등)으로 변환하여 사용합니다.
